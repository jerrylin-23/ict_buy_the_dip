<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Buy the Dip Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #131722;
            color: #d1d4dc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4caf50;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Chart container iframe styling */
        #result-frame {
            width: 100%;
            height: 85vh;
            border: none;
            display: none;
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-[#1e222d] border-b border-[#363c4e] p-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üìâ</span>
            <h1 class="text-xl font-bold text-white">ICT Analyzer</h1>
        </div>
        <div class="flex gap-4">
            <input type="text" id="symbolInput" placeholder="Enter Ticker (e.g. NVDA)"
                class="bg-[#2a2e39] border border-[#363c4e] text-white px-4 py-2 rounded focus:outline-none focus:border-[#4caf50] uppercase"
                onkeypress="if(event.key === 'Enter') analyze()">
            <button onclick="analyze()"
                class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold px-6 py-2 rounded transition flex items-center gap-2">
                <span id="btnText">Analyze</span>
                <div id="loader" class="spinner" style="width: 20px; height: 20px; display: none;"></div>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 bg-[#131722] relative flex flex-col">
        <!-- Toolbar -->
        <div class="bg-[#1e222d] border-b border-[#363c4e] p-2 flex gap-4 text-sm text-[#787b86]">
            <button onclick="showChart()" class="hover:text-white transition">Chart</button>
            <button onclick="runScan()" class="hover:text-white transition">Market Scanner</button>
        </div>

        <div id="chart-view" class="flex-1 relative">
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-[#787b86]">
                <span class="text-6xl mb-4">üîç</span>
                <p class="text-xl">Enter a ticker to generate an Automated Trade Plan</p>
            </div>
            <iframe id="result-frame"></iframe>
        </div>

        <div id="scanner-view" class="flex-1 bg-[#131722] p-8 hidden overflow-y-auto">
            <h2 class="text-2xl text-white mb-4">üöÄ Buy the Dip Scanner</h2>
            <p class="text-[#787b86] mb-8">Scanning for tickers approaching entry (1-3% away from setup).</p>

            <div id="scan-loader" class="text-center py-12 hidden">
                <div class="spinner mb-4"></div>
                <p class="text-[#d1d4dc]">Scanning Markets (IWM, SPY, Tech)... This takes ~30s</p>
            </div>

            <table id="scan-results" class="w-full text-left border-collapse hidden">
                <thead>
                    <tr class="text-[#787b86] border-b border-[#363c4e]">
                        <th class="p-4">Symbol</th>
                        <th class="p-4">Current Price</th>
                        <th class="p-4">Entry Price</th>
                        <th class="p-4">Distance</th>
                        <th class="p-4">Setup Type</th>
                        <th class="p-4">Action</th>
                    </tr>
                </thead>
                <tbody class="text-[#d1d4dc]">
                    <!-- Rows injected here -->
                </tbody>
            </table>
            <div id="scan-empty" class="hidden text-center text-[#787b86] py-12">
                No setups found within range.
            </div>
        </div>
    </div>

    <script>
        function showChart() {
            document.getElementById('chart-view').classList.remove('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
        }

        async function runScan() {
            document.getElementById('chart-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.remove('hidden');

            document.getElementById('scan-loader').classList.remove('hidden');
            document.getElementById('scan-results').classList.add('hidden');
            document.getElementById('scan-empty').classList.add('hidden');

            try {
                const response = await fetch('/scan');
                const data = await response.json();

                const tbody = document.querySelector('#scan-results tbody');
                tbody.innerHTML = ''; // Clear

                if (data.results.length > 0) {
                    data.results.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-[#2a2e39] hover:bg-[#2a2e39] transition";
                        tr.innerHTML = `
                            <td class="p-4 font-bold text-white">${item.symbol}</td>
                            <td class="p-4">$${item.price.toFixed(2)}</td>
                            <td class="p-4 text-[#4caf50]">$${item.entry.toFixed(2)}</td>
                            <td class="p-4 text-[#ffeb3b]">${item.dist.toFixed(2)}%</td>
                            <td class="p-4">${item.setup}</td>
                            <td class="p-4">
                                <button onclick="loadChart('${item.symbol}')" class="bg-[#2962ff] text-white px-3 py-1 rounded text-sm hover:bg-[#1e40af]">View</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    document.getElementById('scan-results').classList.remove('hidden');
                } else {
                    document.getElementById('scan-empty').classList.remove('hidden');
                }

            } catch (error) {
                alert("Scan failed: " + error.message);
            } finally {
                document.getElementById('scan-loader').classList.add('hidden');
            }
        }

        function loadChart(symbol) {
            document.getElementById('symbolInput').value = symbol;
            showChart();
            analyze();
        }

        async function analyze() {
            const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
            if (!symbol) return;
            showChart();

            // UI Updates
            document.getElementById('btnText').innerText = "Analyzing...";
            document.getElementById('loader').style.display = 'inline-block';
            document.getElementById('result-frame').style.display = 'none';
            document.getElementById('placeholder').style.display = 'flex';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol })
                });

                if (!response.ok) throw new Error('Analysis failed');

                const htmlContent = await response.text();

                const frame = document.getElementById('result-frame');
                frame.style.display = 'block';
                document.getElementById('placeholder').style.display = 'none';

                const doc = frame.contentWindow.document;
                doc.open();
                doc.write(htmlContent);
                doc.close();

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                document.getElementById('btnText').innerText = "Analyze";
                document.getElementById('loader').style.display = 'none';
            }
        }
    </script>
</body>

</html>